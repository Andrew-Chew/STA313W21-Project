---
title: "One small change in transportation, one giant leap for the environment"
author: "The (Green)Power Rangers: Ruei-Hung Chen, Andrew Chew, Zhenyu Xuan, Elif Yurek"
date: "16/04/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Note to user: Please ensure that the following packages have been installed prior to running the code.
# Packages can be installed using the command "install.packages('name_of_package')".
# Packages used.
library(dplyr)
library(forcats)
library(ggplot2)
library(ggthemes)
library(highcharter)
library(readxl)
library(shiny)
library(scales)
library(tidyr)

# Empty Shiny App template. 
# ui <- fluidPage("")
# server <- function(input, output) {}
# shinyApp(ui = ui, server = server)
```

<!-- Part 1 -->
## Climate Change & CO^2^ 101
<!-- <<<<<<< HEAD -->

```{r}
data <- read_excel("Data/global emission.3.xlsx") 
df <- data.frame( 
  x= data$`Sub-sector`,
  y=data$`Share of global greenhouse gas emissions (%)`) 
#df 

df_transport <- df %>% slice(1:5)
#df_transport

# Set highcharter options 
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2))) 

highchart () %>% 
  hc_add_series(
    df, 
    "pie",
    hcaes(
      x = x,
      y = y,
      ),
    name = "CO2 emissions by %"
    )  %>%
  hc_plotOptions(
    series = list(
      showInLegend = FALSE,
      pointFormat = "{point.y}%",
      colorByPoint = TRUE
      )) %>%
  hc_title(
    text = "Total Global CO2 Emissions by Sector in 2016"
    ) 

```







=======

<!-- >>>>>>> fb7782ac83b51eb01196f3b294fbca85be9e9c0e -->

<!-- Part 2 -->
## Unsustainable CO^2^ Emissions
```{r part2 setup, include=FALSE}
part2data <- read.csv("Data/owid-co2-data.csv")
part2clean <- part2data[c("country", "year", "cumulative_co2", "cumulative_gas_co2")]

co2emissions_widget = function(dataset) {

  vars = names(dataset)

  shinyApp(
    ui = fluidPage(
      fluidRow(
        column(4, ),
        plotOutput("co2emissions"),
        column(4, )
      ),
      
      # View selector widget.
      fluidRow(
        column(4, ),
        column(4, radioButtons(
          inputId = "view",
          label = "View:",
          choices = list("Total" = 1, "Gas" = 2), 
          selected = 1,
          inline = TRUE)),
        column(4, )
      ),

      # Country selector widget.
      fluidRow(
        column(4, ),
        column(4, selectInput(
          inputId = "country",
          label = "Country:",
          choices = unique(dataset$country),
          selected = "World")),
        column(4, )
      ),
      
      # Year range slider widget.
      fluidRow(
        style = "padding-bottom: 20px;",
        column(4, ),
        column(4, sliderInput(
          inputId = "years",
          label = "Year Range:",
          # Even though data since 1751 was provided, show data starting from 1900.
          min = 1900,
          max = 2019,
          value = c(1900, 2019),
          step = 1,
          width = "100%",
          sep = "",
          dragRange = TRUE)),
        column(4, ))
    ),

    server = function(input, output, session) {
      
      # Put together dataset based on user selections.
      selected_data <- reactive({
        if (input$view == 1) {
            dataset[, c("country", "year", "cumulative_co2")] %>%
            filter(country == input$country) %>%
            group_by(year) %>%
            filter(year >= input$years[1] & year <= input$years[2]) %>%
            summarise(cum = sum(cumulative_co2, na.rm = TRUE))
        }
        else {
            dataset[, c("country", "year", "cumulative_gas_co2")] %>%
            filter(country == input$country) %>%
            group_by(year) %>%
            filter(year >= input$years[1] & year <= input$years[2]) %>%
            summarise(cum = sum(cumulative_gas_co2, na.rm = TRUE))
        }
      })
      
      
      # You can access the value of the widget with input$date, e.g.
      output$co2emissions <- renderPlot({
        ggplot(selected_data(), aes(x = year, y = cum)) +
          geom_point() +
          geom_path() +
          geom_smooth()
#          scale_y_continuous("Billion Tons", labels = unit_format(scale = 1e-3)) +
#          theme_minimal()
        },
        height = 400,
        width = 600)
    },

    options = list(height = 500)
  )
}
```

```{r part2, echo=FALSE}
co2emissions_widget(part2clean)
```


```{r, part2, Vehicle Production}
production_dat <- read_excel("Data/production.xlsx")
production_clean <- production_dat %>% 
  pivot_longer(-c(year), names_to = "Type", values_to = "count") %>% 
  mutate(Type = fct_relevel(Type, "Total Vehicle", after = 2)) %>% 
  group_by(Type)


car_production <- function(data){
  
  # Setting up ui using radio Buttons 
  shinyApp(ui =  fluidPage(
    radioButtons(
      inputId = "vehicle_type",
      label = "Total",
      choices = list("Total" = 1, "Commercial" = 2, "Personal Vehicle"= 3),
      selected = 1,
      inline = TRUE), 
    plotOutput("product")
    ),
  
   
  server = function(input, output) {
    # Select different datasets
    new_dat <- reactive({
      if (input$vehicle_type == 1){
        data %>% 
          filter(Type == "Total Vehicle") %>%
          mutate(count = count/1000000)
      } else if (input$vehicle_type == 2){
        data %>% 
          filter(Type == "Cars") %>%
          mutate(count = count/1000000)
      } else {
        data %>% 
          filter(Type == "Commercial") %>%
          mutate(count = count/1000000) 
      }
    })
    
    # output plot 
    output$product <- renderPlot({
      
      new_dat() %>% 
        ggplot(aes(x = year, y = count, colour = Type)) + 
        geom_line(lwd = 1) +
        labs(title = "Historical Vehicle Productions",
           y = "Number of Vehicles (In millions)",
           x = "Year") +
        theme_wsj()
        },
      height = 400,
      width = 600)
    })
  
}

```



```{r}
production_clean %>% 
  filter(Type != "Cars") %>% 
  mutate(count = count/1000000) %>% 
  ggplot(aes(x = year, y = count, colour = Type))+ 
  geom_line()

```


```{r}
car_production(production_clean)
```



<!-- Part 3 -->
## What's your "Contribution"?

```{r}
ui <- fluidPage(
  
  sliderInput("distance", "How far do you travel every day on average? (km)",min = 0, max = 1000, value = 500),
  plotOutput("distPlot"),
  checkboxGroupInput("icons", "What type of primary vehicle do you use?",
                     choiceNames = list(icon("car"), icon("train"),
                                        icon("plane"),icon("motorcycle"),icon("bus"),icon("subway"), icon("bicycle")),
                     choiceValues = list("car with CO2 emission 10 per kilometer", "train with CO2 emission 8 per kilometer", "plane with CO2 emission 7 per kilometer","motorcycle with CO2 emission 6 per kilometer","bus with CO2 emission 5 per kilometer","subway with CO2 emission 3 per kilometer", "bicycle with CO2 emission 1 per kilometer")
  ),
  textOutput("txt")
)

server <- function(input, output, session) {
  output$txt <- renderText({
    icons <- paste(input$icons, collapse = ", ")
    paste("You chose", icons)
    })
  # Reactive expression to create data frame of all input values ----
}

shinyApp(ui, server)
```

```{r}
#the CO2 emission per kilometer for various types of cars
car_index <- 10
train_index <- 8
flight_index <- 7
motorcycle_index <- 6
bus_index <- 5
subway_index <- 3
bike_index <- 1

#calculate the CO2 emission for each vehicle
time = c(2021,2022,2023,2024,2025)
CO2_emission_car <- car_index*(time - 2021)
CO2_emission_train <- train_index*(time - 2021)
CO2_emission_flight <- flight_index*(time - 2021)
CO2_emission_motorcycle <- motorcycle_index*(time - 2021)
CO2_emission_bus <- bus_index*(time - 2021)
CO2_emission_subway <- subway_index*(time - 2021)
CO2_emission_bike <- bike_index*(time - 2021)

#plot the graph
plot(CO2_emission_car,type = "o",col = "red", xlab = "Time (years)", ylab = "CO2 emission", 
   main = "Impact of choosing alternative means of transports",lwd=3)
lines(CO2_emission_train, type = "o", col = "orange",lwd=3)
lines(CO2_emission_flight, type = "o", col = "blue",lwd=3)
lines(CO2_emission_motorcycle, type = "o", col = "yellow",lwd=3)
lines(CO2_emission_bus, type = "o", col = "grey",lwd=3)
lines(CO2_emission_subway, type = "o", col = "black",lwd=3)
lines(CO2_emission_bike, type = "o", col = "green",lwd=3)

legend("topleft", legend = c("car","train","flight","motorcycle","bus","subway","bike"),col=c("red","orange","blue","yellow","grey","black", "green"), lwd = 2, cex = 0.7)
```

<!-- Part 4 -->
## How can you help?

<!-- Conclusion -->
## Flatten the curve!
